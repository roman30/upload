<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>فرم‌ساز نهایی — نسخه 10+ (Text/Checkbox/Radio/Combo)</title>
<style>
  :root{
    --primary:#3b82f6; --primary-600:#2563eb; --danger:#ef4444; --success:#10b981;
    --bg:#f5f7fb; --muted:#6b7280; --card:#ffffff; --border:#e5e7eb;
    --chip:#f3f4f6; --tooltip:#111827; --tooltip-text:#fff;
  }
  *{box-sizing:border-box}
  body{font-family:tahoma,iransans,Arial,system-ui;background:var(--bg);margin:0;color:#111827}
  header{background:linear-gradient(90deg,var(--primary),var(--primary-600));color:#fff;padding:12px 16px;text-align:center}
  .container{display:flex;flex-wrap:wrap;gap:12px;padding:12px;align-items:flex-start}
  .panel{flex:1;min-width:310px;background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.05)}
  .panel h2{margin:0;padding:12px 14px;border-bottom:1px solid var(--border);font-size:16px}
  .panel .body{padding:12px 14px}
  .btn{background:var(--primary);color:#fff;border:none;border-radius:10px;padding:8px 10px;margin:2px;cursor:pointer;font-size:14px}
  .btn:hover{filter:brightness(.95)}
  .btn.ghost{background:#e9f2ff;color:#0b58c1}
  .btn.success{background:var(--success)}
  .btn.danger{background:var(--danger)}
  .btn.icon{padding:6px 8px;border-radius:8px}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:flex-end}
  .row > .col{flex:1;min-width:200px}
  input,select,textarea{width:100%;padding:8px;border:1px solid #d1d5db;border-radius:10px;background:#fff}
  label{display:block;margin:6px 0 4px;font-weight:600}
  .muted{color:var(--muted);font-size:12px}
  .field-card{display:flex;align-items:center;justify-content:space-between;background:#fff;border:1px solid #eee;border-radius:12px;padding:8px 10px;margin-bottom:8px}
  .chip{background:var(--chip);border:1px solid var(--border);border-radius:999px;padding:2px 8px;margin-left:6px;font-size:12px}
  .form-field{background:#fafafa;border:1px solid var(--border);border-radius:12px;padding:10px;margin-bottom:10px;position:relative}
  .help-img{width:18px;height:18px;object-fit:cover;border-radius:4px;border:1px solid #ddd;margin-right:4px;vertical-align:middle}
  .req-star{color:#ef4444;margin:0 4px;font-size:14px}
  .tooltip-icon{display:inline-flex;justify-content:center;align-items:center;width:18px;height:18px;border-radius:50%;background:#cde3ff;color:#0b58c1;font-size:12px;margin-right:6px;cursor:pointer}
  .tooltip-bubble{position:absolute;z-index:5;max-width:260px;background:var(--tooltip);color:var(--tooltip-text);padding:8px 10px;border-radius:8px;font-size:12px;line-height:1.6;display:none;box-shadow:0 10px 30px rgba(0,0,0,.2)}
  .tooltip-bubble.show{display:block}
  .drag{cursor:move;margin-left:8px}
  .drag-over{outline:2px dashed var(--primary)}
  textarea.code{height:220px;font-family:ui-monospace,Menlo,Consolas,monospace}
  /* grid for label/component ratio */
  .grid12{display:grid;grid-template-columns:repeat(12,1fr);gap:8px;align-items:center}
  .input-size-large input{height:48px;font-size:16px}
  .input-size-medium input{height:40px;font-size:14px}
  .input-size-small input{height:34px;font-size:13px}
  .input-size-verysmall input{height:30px;font-size:12px}
  .maximized .form-field-inner input,.maximized .form-field-inner select{font-size:18px;padding:12px}
  .collapsed .form-field-inner{opacity:.85}
  /* Toggle switch */
  .switch{position:relative;display:inline-block;width:44px;height:24px;vertical-align:middle}
  .switch input{display:none}
  .switch .slider{position:absolute;inset:0;background:#d1d5db;border-radius:24px;transition:.2s}
  .switch .slider:before{content:"";position:absolute;height:18px;width:18px;left:3px;top:3px;background:#fff;border-radius:50%;transition:.2s}
  .switch input:checked + .slider{background:#22c55e}
  .switch input:checked + .slider:before{transform:translateX(20px)}
  /* Modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:50}
  .modal{width:min(940px,94vw);max-height:90vh;overflow:auto;background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.25)}
  .modal header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #eee}
  .modal .content{padding:14px}
  .modal .footer{display:flex;justify-content:flex-end;gap:8px;padding:12px 14px;border-top:1px solid #eee}
  .tabs{display:flex;gap:8px;margin-bottom:10px}
  .tabs button{background:#eef2ff;color:#1e3a8a;padding:8px 10px;border:none;border-radius:999px;cursor:pointer}
  .tabs button.active{background:#1e3a8a;color:#fff}
  .tabpane{display:none}
  .tabpane.active{display:block}
  .group{display:grid;grid-template-columns:repeat(12,1fr);gap:10px;align-items:end;margin-bottom:12px}
  .group .g-6{grid-column:span 6}
  .group .g-4{grid-column:span 4}
  .group .g-3{grid-column:span 3}
  .group .g-12{grid-column:span 12}
  @media (max-width:768px){
    .buttons-desktop{display:none}
    .select-mobile{display:block}
    .group{grid-template-columns:repeat(6,1fr)}
    .group .g-6,.group .g-4,.group .g-3,.group .g-12{grid-column:span 6}
  }
  @media (min-width:769px){.select-mobile{display:none}}
  /* option editor */
  .option-row{display:grid;grid-template-columns:18px 1fr 1fr 1fr 26px;gap:6px;align-items:center;margin-bottom:6px}
  .option-row .handle{cursor:move;text-align:center}
  .option-row .remove{color:#ef4444;font-weight:bold;cursor:pointer;text-align:center}
  .option-row input{padding:6px 8px}
  .opt-list{background:#f8fafc;border:1px dashed #cbd5e1;border-radius:10px;padding:8px}

.form-preview input[type="radio"],
.form-preview input[type="checkbox"] {
  transform: scale(1.2);
  margin-right: 6px;
}


/* --- Uniform fb-control for checkboxes and radios --- */
.form-preview input[type="checkbox"],
.form-preview input[type="radio"] {
  width: 18px;
  height: 18px;
  transform: none !important;
  margin: 0 6px 0 0;
  vertical-align: middle;
}

</style>

<style>
/* Fix radio button size in preview */


</style>


<style>
/* Fix radio button size in preview column only */

</style>


<style>

</style>

</head>
<body>
<header><h1>🛠️ فرم‌ساز — متن / چک‌باکس / رادیویی / آبشاری</h1></header>

<div class="container">
  <!-- Builder -->
  <section class="panel">
    <h2>ابزار ساخت</h2>
    <div class="body">
      <div class="buttons-desktop">
        <div class="row">
          <button class="btn icon" onclick="addField('text')">🅣 متن</button>
          <button class="btn icon" onclick="addField('checkbox')">☑️ چک‌باکس</button>
          <button class="btn icon" onclick="addField('radio')">🔘 رادیو</button>
          <button class="btn icon" onclick="addField('combo')">▾ آبشاری</button>
        </div>
      </div>
      <div class="select-mobile">
        <div class="row">
          <select id="fieldTypeSelect">
            <option value="">— نوع فیلد —</option>
            <option value="text">متن</option>
            <option value="checkbox">چک‌باکس</option>
            <option value="radio">رادیویی</option>
            <option value="combo">آبشاری</option>
          </select>
          <button class="btn success" onclick="addSelectedField()">➕ افزودن</button>
        </div>
      </div>

      <h3>لیست فیلدها</h3>
      <div id="fieldList"></div>

      <div class="row" style="margin-top:8px">
        <button class="btn success" onclick="collectData()">📥 جمع‌آوری داده‌ها</button>
        <button class="btn ghost" onclick="exportJSON()">📤 Export JSON</button>
        <button class="btn ghost" onclick="importJSON()">📥 Import JSON</button>
        <button class="btn danger" onclick="clearAll()">🗑 پاک کردن همه</button>
      </div>
      <div class="muted" style="margin-top:6px">نکته: با ⚙️ تنظیمات هر فیلد را باز کن. می‌توانی با کشیدن در لیست، ترتیب را عوض کنی.</div>
    </div>
  </section>

  <!-- Preview -->
  <section class="panel">
    <h2>پیش‌نمایش</h2>
    <div class="body">
      <form id="formPreview"></form>
    </div>
  </section>

  <!-- JSON -->
  <section class="panel">
    <h2>JSON / داده‌ها</h2>
    <div class="body">
      <label>Schema</label>
      <textarea id="jsonSchema" class="code" readonly></textarea>
      <label>Import</label>
      <textarea id="jsonImport" class="code" placeholder='{"fields":[...]}'></textarea>
      <label>Filled Data</label>
      <textarea id="dataOutput" class="code" readonly></textarea>
    </div>
  </section>
</div>

<!-- Modal -->
<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <header>
      <strong id="modalTitle">⚙️ تنظیمات فیلد</strong>
      <button class="btn danger" onclick="closeModal()">بستن</button>
    </header>
    <div class="content modal-body" id="modalContent"></div>
    <div class="footer">
      <button class="btn" onclick="closeModal()">انصراف</button>
      <button class="btn success" onclick="saveFieldFromModal()">ذخیره</button>
    </div>
  </div>
</div>

<script>
let fields = [];
let editingIndex = null;

function saveToStorage(){ localStorage.setItem("form_fields_final10", JSON.stringify(fields)); }
function loadFromStorage(){
  try{
    const data = localStorage.getItem("form_fields_final10");
    if(data){ fields = JSON.parse(data) || []; }
  }catch(e){ fields = []; }
  renderAll();
}

function uid(){ return 'f' + Math.random().toString(36).slice(2,9); }
function addSelectedField(){ const t = document.getElementById('fieldTypeSelect').value; if(t) addField(t); }

function addField(type){
  const id = uid();
  const base = {
    id, type,
    label: type==='text' ? 'متن' : (type==='checkbox'?'چک‌باکس': type==='radio'?'رادیویی':'آبشاری'),
    name: type + "_" + id,
    description: "",           // برای Tooltip
    tooltip: "",               // درصورت نیاز
    required:false,
    readOnly:false,
    collapsed:false,
    fullscreen:false,
    spssTitle:"",
    hl7tag:"",
    labelColor:"#111111",
    styleLabel:"",
    styleComponent:"",
    inputSize:"medium",        // large | medium | small | verysmall
    width:"col-md-12",
    layout:"1-4-8",            // offset-label-component
    helpImage:{enabled:false, url:""},
    parent1:"",
    parent2:""
  };

  if(type==='text'){
    Object.assign(base, {
      direction:'rtl',
      placeholder:'',
      defaultValue:'',
      minLength:null,
      maxLength:null,
      regex:'',
      regexPreset:''           // email|mobile|nationalId|postalCode|none
    });
  }
  if(type==='checkbox' || type==='radio'){
    Object.assign(base, {
      orientation:'vertical',  // vertical | horizontal
      options:[
        {value:'opt1',label:'گزینه ۱',desc:''},
        {value:'opt2',label:'گزینه ۲',desc:''}
      ]
    });
  }
  if(type==='combo'){
    Object.assign(base, {
      optionsSource:'manual', // manual | database
      codingKey:'',           // وقتی database
      options:[
        {value:'val1',label:'برچسب ۱',desc:''},
        {value:'val2',label:'برچسب ۲',desc:''}
      ]
    });
  }

  fields.push(base);
  saveToStorage(); renderAll();
}

function moveField(i,dir){
  const j = i+dir; if(j<0||j>=fields.length) return;
  [fields[i],fields[j]] = [fields[j],fields[i]];
  saveToStorage(); renderAll();
}
function deleteField(i){ fields.splice(i,1); saveToStorage(); renderAll(); }
function clearAll(){ if(confirm("همه فیلدها حذف شوند؟")){ fields=[]; saveToStorage(); renderAll(); } }

function renderBuilder(){
  const list = document.getElementById('fieldList');
  list.innerHTML = "";
  fields.forEach((f,i)=>{
    const div = document.createElement('div'); div.className="field-card"; div.setAttribute('draggable','true');
    div.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', i.toString()); div.classList.add('dragging'); });
    div.addEventListener('dragend', ()=> div.classList.remove('dragging'));
    div.addEventListener('dragover', e=>{
      e.preventDefault();
      const dragging = list.querySelector('.dragging'); if(!dragging) return;
      const after = Array.from(list.querySelectorAll('.field-card:not(.dragging)')).find(el => e.clientY <= el.getBoundingClientRect().top + el.offsetHeight/2);
      if(after==null) list.appendChild(dragging); else list.insertBefore(dragging, after);
    });
    div.addEventListener('drop', ()=>{
      const order = Array.from(list.children).map(el => Array.from(list.children).indexOf(el));
      // بازسازی بر اساس DOM: ساده‌تر → از fields با برچسب id
      const newOrder = Array.from(list.children).map(el => el.dataset.id);
      const reordered = newOrder.map(id => fields.find(x=>x.id===id));
      fields = reordered;
      saveToStorage(); renderAll();
    });
    div.dataset.id = f.id;
    div.innerHTML = `
      <div>
        <span class="chip">${iconForType(f.type)} ${f.type.toUpperCase()}</span>
        <strong>${f.label || f.name}</strong>
        ${f.required ? '<span class="chip" title="Required">الزامی</span>' : ''}
      </div>
      <div>
        <span class="drag" title="Drag">☰</span>
        <button class="btn ghost" onclick="openModal(${i})">⚙️</button>
        <button class="btn" onclick="moveField(${i},-1)">⬆️</button>
        <button class="btn" onclick="moveField(${i},1)">⬇️</button>
        <button class="btn danger" onclick="deleteField(${i})">❌</button>
      </div>`;
    list.appendChild(div);
  });
}
function iconForType(t){
  switch(t){
    case 'text': return '🅣';
    case 'checkbox': return '☑️';
    case 'radio': return '🔘';
    case 'combo': return '▾';
    default: return '🔧';
  }
}

function parseLayout(val){
  const m = (val||'').match(/^(\d+)-(\d+)-(\d+)$/); if(!m) return [0,4,8];
  return [parseInt(m[1]), parseInt(m[2]), parseInt(m[3])];
}
function sizeToClass(sz){
  switch((sz||'').toLowerCase()){
    case 'large': return 'input-size-large';
    case 'small': return 'input-size-small';
    case 'verysmall': return 'input-size-verysmall';
    default: return 'input-size-medium';
  }
}

function renderPreview(){
  const form = document.getElementById('formPreview');
  form.innerHTML = "";
  fields.forEach(f=>{
    const outer = document.createElement('div');
    outer.className = "form-field";
    const col = parseInt((f.width||'col-md-12').replace('col-md-',''))||12;
    outer.style.flex = `0 0 ${Math.round(col/12*100)}%`;
    outer.style.maxWidth = `${Math.round(col/12*100)}%`;
    if(f.collapsed) outer.classList.add('collapsed');
    if(f.fullscreen) outer.classList.add('maximized');

    const [off,lbl,cmp] = parseLayout(f.layout||"1-4-8");
    const labelStyle = `color:${f.labelColor||'#111'};${f.styleLabel||''}`;
    const inputStyle = `${f.styleComponent||''}`;
    const sizeClass = sizeToClass(f.inputSize||'medium');
    const reqStar = f.required ? `<span class="req-star" aria-hidden="true">*</span>` : '';
    const helpImg = (f.helpImage && f.helpImage.enabled && f.helpImage.url) ? `<img class="help-img" src="${escapeAttr(f.helpImage.url)}" alt="help">` : '';
    const tooltipIcon = f.description ? `<span class="tooltip-icon" onclick="toggleTip(this)" title="راهنما">❔</span>` : '';
    const tipBubble = f.description ? `<div class="tooltip-bubble">${escapeHtml(f.description)}</div>` : '';
    const titleAttr = f.description ? `title="${escapeAttr(f.description)}"` : '';

    let html = `<div class="form-field-inner ${sizeClass}">
      <div class="grid12">
        <div class="label-cell" style="grid-column:${off+1} / span ${lbl}">
          <label style="${labelStyle}">${helpImg}${escapeHtml(f.label||'')} ${reqStar} ${f.description ? `<span class=\"tooltip-icon\" data-tooltip=\"${escapeHtml(f.description)}\">❔</span>` : ""}</label>
        </div>
        <div class="input-cell" style="grid-column:${off+1+lbl} / span ${cmp}; position:relative">
    `;
    // Render component by type
    if(f.type==='text'){
      const readOnly = f.readOnly ? 'readonly' : '';
      const reqAttr = f.required ? 'required' : '';
      const maxAttr = f.maxLength? `maxlength="${Number(f.maxLength)}"` : '';
      const minAttr = f.minLength? `minlength="${Number(f.minLength)}"` : '';
      const dirAttr = f.direction==='ltr'? 'ltr':'rtl';
      const regexAttr = f.regex? `data-regex="${escapeAttr(f.regex)}"` : '';
      html += `<input dir="${dirAttr}" ${readOnly} ${reqAttr} ${maxAttr} ${minAttr} ${regexAttr}
               style="${inputStyle}" type="text" name="${escapeAttr(f.name)}"
               placeholder="${escapeAttr(f.placeholder||'')}" value="${escapeAttr(f.defaultValue||'')}"
               oninput="validateInput(this)">`;
    }
    if(f.type==='checkbox'){
    if(!validateUniqueOptions('o_list')) return;
      const wrapStyle = f.orientation==='horizontal' ? 'display:flex;gap:10px;flex-wrap:wrap' : '';
      html += `<div style="${wrapStyle}">` + (f.options||[]).map((o,idx)=>`
        <label class="chip" style="display:inline-flex;align-items:center;gap:6px;margin:4px 6px">
          <input type="checkbox" name="${escapeAttr(f.name)}" value="${escapeAttr(o.value)}">
          <span>${escapeHtml(o.label)}</span>
          ${o.desc? `<span class="tooltip-icon" onclick="toggleTip(this)">❔</span>`:''}
          ${o.desc? `<div class="tooltip-bubble">${escapeHtml(o.desc)}</div>`:''}
        </label>
      `).join('') + `</div>`;
    }
    if(f.type==='radio'){
    if(!validateUniqueOptions('o_list')) return;
      const wrapStyle = f.orientation==='horizontal' ? 'display:flex;gap:10px;flex-wrap:wrap' : '';
      html += `<div style="${wrapStyle}">` + (f.options||[]).map((o,idx)=>`
        <label class="chip" style="display:inline-flex;align-items:center;gap:6px;margin:4px 6px">
          <input type="radio" name="${escapeAttr(f.name)}" value="${escapeAttr(o.value)}">
          <span>${escapeHtml(o.label)}</span>
          ${o.desc? `<span class="tooltip-icon" onclick="toggleTip(this)">❔</span>`:''}
          ${o.desc? `<div class="tooltip-bubble">${escapeHtml(o.desc)}</div>`:''}
        </label>
      `).join('') + `</div>`;
    }
    if(f.type==='combo'){
    if(f.optionsSource==='manual'){
      if(!validateUniqueOptions('c_list')) return;
    }
      if(f.optionsSource==='database'){
        html += `<select name="${escapeAttr(f.name)}" style="${inputStyle}" ${f.readOnly?'disabled':''}>
          <option value="">— در زمان اجرا از دیتابیس «${escapeHtml(f.codingKey||'Coding')}» بارگذاری می‌شود —</option>
        </select>`;
      }else{
        html += `<select name="${escapeAttr(f.name)}" style="${inputStyle}" ${f.readOnly?'disabled':''}>
          ${(f.options||[]).map(o=>`<option value="${escapeAttr(o.value)}">${escapeHtml(o.label)}</option>`).join('')}
        </select>`;
      }
    }
    html += `${tipBubble}</div></div></div>`;
    outer.innerHTML = html;
    form.appendChild(outer);
  });

  // desktop hover: show bubble on parent hover (simulate via title is also set)
  form.querySelectorAll('.tooltip-icon').forEach(icon=>{
    icon.addEventListener('mouseenter', ()=>{
      const bubble = icon.parentElement.querySelector('.tooltip-bubble');
      if(bubble){ positionBubble(icon,bubble); bubble.classList.add('show'); }
    });
    icon.addEventListener('mouseleave', ()=>{
      const bubble = icon.parentElement.querySelector('.tooltip-bubble');
      if(bubble){ bubble.classList.remove('show'); }
    });
  });
}
function positionBubble(trigger,bubble){
  const r = trigger.getBoundingClientRect();
  bubble.style.top = (trigger.offsetTop - bubble.offsetHeight - 8) + 'px';
  bubble.style.right = '0';
}
function toggleTip(el){
  const bubble = el.parentElement.querySelector('.tooltip-bubble');
  if(!bubble) return;
  bubble.classList.toggle('show');
  positionBubble(el,bubble);
}

function validateInput(input){
  const regex = input.getAttribute("data-regex");
  const min = parseInt(input.getAttribute("minlength")) || null;
  const max = parseInt(input.getAttribute("maxlength")) || null;
  const val = input.value || '';
  let valid = true;
  if(min && val.length < min) valid = false;
  if(max && val.length > max) valid = false;
  if(regex){ try{ const r = new RegExp(regex); if(val && !r.test(val)) valid = false; }catch(e){ /* ignore */ } }
  if(input.required && !val.trim()) valid = false;
  input.style.borderColor = valid? '#10b981' : '#ef4444';
}

/* ---------- Modal ---------- */
function openModal(i){
  editingIndex = i;
  const f = fields[i];
  const el = document.getElementById('modalContent');

  const general = `
    <div class="group">
      <div class="g-6">
        <label>Label (عنوان) <span class="req-star">*</span></label>
        <input id="m_label" value="${escapeAttr(f.label||'')}">
      </div>
      <div class="g-6">
        <label>Name (شناسه فنی)</label>
        <input id="m_name" value="${escapeAttr(f.name||'')}">
      </div>
      <div class="g-6">
        <label>Description (توضیحات برای Tooltip)</label>
        <input id="m_desc" value="${escapeAttr(f.description||'')}">
      </div>
      <div class="g-6">
        <label>Tooltip (اختیاری)</label>
        <input id="m_tooltip" value="${escapeAttr(f.tooltip||'')}">
      </div>

      <div class="g-3">
        <label>Required</label>
        <label class="switch"><input type="checkbox" id="m_required" ${f.required?'checked':''}><span class="slider"></span></label>
      </div>
      <div class="g-3">
        <label>ReadOnly</label>
        <label class="switch"><input type="checkbox" id="m_readonly" ${f.readOnly?'checked':''}><span class="slider"></span></label>
      </div>
      <div class="g-3">
        <label>Collapsed</label>
        <label class="switch"><input type="checkbox" id="m_collapsed" ${f.collapsed?'checked':''}><span class="slider"></span></label>
      </div>
      <div class="g-3">
        <label>Fullscreen</label>
        <label class="switch"><input type="checkbox" id="m_fullscreen" ${f.fullscreen?'checked':''}><span class="slider"></span></label>
      </div>

      <div class="g-6">
        <label>SPSS Title</label>
        <input id="m_spss" value="${escapeAttr(f.spssTitle||'')}">
      </div>
      <div class="g-6">
        <label>HL7TAG</label>
        <input id="m_hl7" value="${escapeAttr(f.hl7tag||'')}">
      </div>

      <div class="g-6">
        <label>رنگ برچسب</label>
        <input type="color" id="m_labelColor" value="${escapeAttr(f.labelColor||'#111111')}">
      </div>
      <div class="g-6">
        <label>Style Label (CSS)</label>
        <input id="m_styleLabel" value="${escapeAttr(f.styleLabel||'')}">
      </div>
      <div class="g-6">
        <label>Style Component (CSS)</label>
        <input id="m_styleComponent" value="${escapeAttr(f.styleComponent||'')}">
      </div>
      <div class="g-6">
        <label>Input Size</label>
        <select id="m_inputSize">
          ${['large','medium','small','verysmall'].map(s=>`<option value="${s}" ${(f.inputSize||'medium')===s?'selected':''}>${s}</option>`).join('')}
        </select>
      </div>

      <div class="g-6">
        <label>پهنای آیتم</label>
        <select id="m_width">${[12,11,10,9,8,7,6,5,4,3,2,1].map(n=>`<option value="col-md-${n}" ${f.width===`col-md-${n}`?'selected':''}>${n}</option>`).join('')}</select>
      </div>
      <div class="g-6">
        <label>نوع نمایش (offset-label-component)</label>
        <select id="m_layout">
          ${['','1-3-9','1-4-8','1-5-7','1-6-6','1-7-5','1-8-4','1-9-3','2-3-9','2-4-8','2-5-7','2-6-6','2-7-5','2-8-4','2-9-3'].map(v=>`<option value="${v}" ${(f.layout||'')===v?'selected':''}>${v||'default'}</option>`).join('')}
        </select>
      </div>

      <div class="g-6">
        <label>عکس راهنما</label>
        <label class="switch"><input type="checkbox" id="m_help_enabled" ${f.helpImage?.enabled?'checked':''}><span class="slider"></span></label>
      </div>
      <div class="g-6">
        <label>آپلود تصویر راهنما</label>
        <input type="file" id="m_help_file" accept="image/*">
      </div>

      <div class="g-6">
        <label>فیلد بالادستی ۱</label>
        <select id="m_parent1">${parentOptions(f.parent1)}</select>
      </div>
      <div class="g-6">
        <label>فیلد بالادستی ۲</label>
        <select id="m_parent2">${parentOptions(f.parent2)}</select>
      </div>
    </div>
  `;

  // specific settings
  let specific = '';
  if(f.type==='text'){
    specific = `
      <div class="group">
        <div class="g-4">
          <label>جهت</label>
          <select id="t_dir">
            <option value="rtl" ${f.direction!=='ltr'?'selected':''}>rtl</option>
            <option value="ltr" ${f.direction==='ltr'?'selected':''}>ltr</option>
          </select>
        </div>
        <div class="g-4">
          <label>حداقل طول</label>
          <input type="number" id="t_min" value="${f.minLength??''}">
        </div>
        <div class="g-4">
          <label>حداکثر طول</label>
          <input type="number" id="t_max" value="${f.maxLength??''}">
        </div>
        <div class="g-6">
          <label>Placeholder</label>
          <input id="t_placeholder" value="${escapeAttr(f.placeholder||'')}">
        </div>
        <div class="g-6">
          <label>پیش‌فرض</label>
          <input id="t_default" value="${escapeAttr(f.defaultValue||'')}">
        </div>
        <div class="g-6">
          <label>Regex (سفارشی)</label>
          <input id="t_regex" placeholder="مثلا ^[0-9]{10}$" value="${escapeAttr(f.regex||'')}">
        </div>
        <div class="g-6">
          <label>Regex Preset</label>
          <select id="t_regexPreset">
            ${['','email','mobile','nationalId','postalCode'].map(p=>`<option value="${p}" ${(f.regexPreset||'')===p?'selected':''}>${p||'none'}</option>`).join('')}
          </select>
        </div>
      </div>
    `;
  }
  if(f.type==='checkbox' || f.type==='radio'){
    if(!validateUniqueOptions('o_list')) return; // جلوگیری از ذخیره مقادیر تکراری
    specific = `
      <div class="group">
        <div class="g-6">
          <label>چیدمان</label>
          <select id="o_orientation">
            <option value="vertical" ${f.orientation!=='horizontal'?'selected':''}>عمودی</option>
            <option value="horizontal" ${f.orientation==='horizontal'?'selected':''}>افقی</option>
          </select>
        </div>
        <div class="g-12">
          <label>گزینه‌ها (Value / Label / Description)</label>
          <div id="o_list" class="opt-list"></div>
          <button type="button" class="btn ghost" onclick="addOptionEditorRow()">➕ افزودن گزینه</button>
        </div>
      </div>
    `;
  }
  if(f.type==='combo'){
    if(f.optionsSource==='manual'){
      if(!validateUniqueOptions('c_list')) return;
    }
    specific = `
      <div class="group">
        <div class="g-6">
          <label>منبع گزینه‌ها</label>
          <select id="c_source">
            <option value="manual" ${f.optionsSource!=='database'?'selected':''}>Manual</option>
            <option value="database" ${f.optionsSource==='database'?'selected':''}>Database</option>
          </select>
        </div>
        <div class="g-6">
          <label>کدینگ دیتابیس (وقتی Database)</label>
          <select id="c_coding">
            ${codingList().map(k=>`<option value="${k}" ${f.codingKey===k?'selected':''}>${k}</option>`).join('')}
          </select>
        </div>
        <div class="g-12" id="c_manual_block">
          <label>گزینه‌ها (Value / Label / Description)</label>
          <div id="c_list" class="opt-list"></div>
          <button type="button" class="btn ghost" onclick="addOptionEditorRow('combo')">➕ افزودن گزینه</button>
        </div>
      </div>
    `;
  }

  el.innerHTML = `
    <div class="tabs">
      <button class="tabbtn active" data-tab="gen">تنظیمات عمومی</button>
      <button class="tabbtn" data-tab="spec">تنظیمات اختصاصی</button>
    </div>
    <div id="tab_gen" class="tabpane active">${general}</div>
    <div id="tab_spec" class="tabpane">${specific || '<div class="muted">این نوع فیلد تنظیمات اختصاصی ندارد.</div>'}</div>
  `;

  // Tabs
  el.querySelectorAll('.tabbtn').forEach(btn=>{
    btn.onclick = ()=>{
      el.querySelectorAll('.tabbtn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const tab = btn.dataset.tab;
      el.querySelectorAll('.tabpane').forEach(p=>p.classList.remove('active'));
      document.getElementById('tab_'+tab).classList.add('active');
    };
  });

  // preload option editors
  if(f.type==='checkbox' || f.type==='radio'){
    if(!validateUniqueOptions('o_list')) return; // جلوگیری از ذخیره مقادیر تکراری
    const list = document.getElementById('o_list');
    (f.options||[]).forEach(o=> addOptionRow(list, o.value, o.label, o.desc));
    makeListSortable(list);
  }
  if(f.type==='combo'){
    if(f.optionsSource==='manual'){
      if(!validateUniqueOptions('c_list')) return;
    }
    const manBlock = document.getElementById('c_manual_block');
    const srcSel = document.getElementById('c_source');
    const list = document.getElementById('c_list');
    const toggleManual = ()=> manBlock.style.display = (srcSel.value==='manual') ? 'block' : 'none';
    srcSel.onchange = toggleManual; toggleManual();
    (f.options||[]).forEach(o=> addOptionRow(list, o.value, o.label, o.desc));
    makeListSortable(list);
  }

  // help image file preview
  const file = document.getElementById('m_help_file');
  if(file){ file.onchange = (e)=>{
    const fl = e.target.files[0]; if(!fl) return;
    const url = URL.createObjectURL(fl);
    // موقتا روی شیء فیلد می‌نشانیم؛ در ذخیره نهایی هم اعمال می‌شود
    f.helpImage = {enabled:true, url};
  };}

  document.getElementById('modalBackdrop').style.display='flex';
  document.getElementById('modalTitle').textContent = `⚙️ تنظیمات: ${f.label || f.name}`;
}
function parentOptions(selected){
  const opts = ['<option value="">(بدون)</option>'];
  fields.forEach(ff=>{
    opts.push(`<option value="${ff.id}" ${selected===ff.id?'selected':''}>${escapeAttr(ff.label||ff.name)}</option>`);
    if(ff.options && Array.isArray(ff.options)){
      ff.options.forEach(o=>{
        const val = ff.id + '::' + o.value;
        const text = `${ff.label||ff.name} — ${o.label}`;
        opts.push(`<option value="${val}" ${selected===val?'selected':''}>${escapeAttr(text)}</option>`);
      });
    }
  });
  return opts.join('');
}
function codingList(){
  return ['ICD10','ATC','DrugCode','City','State','Relation','Day','ShamsiMonth','ShamsiYear'];
}
function addOptionEditorRow(kind){
  const list = (kind==='combo') ? document.getElementById('c_list') : document.getElementById('o_list');
  addOptionRow(list,'','','');
}
function addOptionRow(container, value='', label='', desc=''){
  const row = document.createElement('div');
  row.className = 'option-row';
  row.innerHTML = `
    <span class="handle">☰</span>
    <input class="opt-value" placeholder="Value" value="${escapeAttr(value)}">
    <input class="opt-label" placeholder="Label" value="${escapeAttr(label)}">
    <input class="opt-desc" placeholder="Description" value="${escapeAttr(desc)}">
    <span class="remove" title="حذف">✖</span>
  `;
  row.querySelector('.remove').onclick = ()=> row.remove();
  container.appendChild(row);
}
function makeListSortable(container){
  let dragEl=null;
  container.querySelectorAll('.option-row').forEach(row=>{
    row.draggable = true;
    row.addEventListener('dragstart', ()=>{ dragEl=row; row.classList.add('dragging'); });
    row.addEventListener('dragend', ()=>{ if(dragEl) dragEl.classList.remove('dragging'); dragEl=null; });
  });
  container.addEventListener('dragover', (e)=>{
    e.preventDefault();
    const after = Array.from(container.querySelectorAll('.option-row:not(.dragging)'))
      .find(el => e.clientY <= el.getBoundingClientRect().top + el.offsetHeight/2);
    if(!dragEl) return;
    if(after==null) container.appendChild(dragEl); else container.insertBefore(dragEl, after);
  });
}

function closeModal(){ document.getElementById('modalBackdrop').style.display='none'; editingIndex=null; }

function saveFieldFromModal(){
  if(editingIndex===null) return;
  const f = fields[editingIndex];

  // validate label
  const labelVal = document.getElementById('m_label').value.trim();
  if(!labelVal){ alert('برچسب الزامی است.'); return; }

  // عمومی
  f.label = labelVal;
  f.name = (document.getElementById('m_name').value.trim()) || (f.type+'_'+f.id);
  f.description = document.getElementById('m_desc').value.trim();
  f.tooltip = document.getElementById('m_tooltip').value.trim();
  f.required = document.getElementById('m_required').checked;
  f.readOnly = document.getElementById('m_readonly').checked;
  f.collapsed = document.getElementById('m_collapsed').checked;
  f.fullscreen = document.getElementById('m_fullscreen').checked;
  f.spssTitle = document.getElementById('m_spss').value.trim();
  f.hl7tag = document.getElementById('m_hl7').value.trim();
  f.labelColor = document.getElementById('m_labelColor').value || '#111111';
  f.styleLabel = document.getElementById('m_styleLabel').value.trim();
  f.styleComponent = document.getElementById('m_styleComponent').value.trim();
  f.inputSize = document.getElementById('m_inputSize').value;
  f.width = document.getElementById('m_width').value;
  f.layout = document.getElementById('m_layout').value || '1-4-8';
  const helpEnabled = document.getElementById('m_help_enabled').checked;
  f.helpImage = f.helpImage || {enabled:false, url:''};
  f.helpImage.enabled = helpEnabled;
  // اگر فایل جدید انتخاب نشده بود، url قبلی حفظ می‌شود
  f.parent1 = document.getElementById('m_parent1').value;
  f.parent2 = document.getElementById('m_parent2').value;

  // اختصاصی
  if(f.type==='text'){
    f.direction = document.getElementById('t_dir').value;
    const minV = document.getElementById('t_min').value; f.minLength = minV!==''? Number(minV): null;
    const maxV = document.getElementById('t_max').value; f.maxLength = maxV!==''? Number(maxV): null;
    f.placeholder = document.getElementById('t_placeholder').value;
    f.defaultValue = document.getElementById('t_default').value;
    const preset = document.getElementById('t_regexPreset').value;
    f.regexPreset = preset;
    f.regex = document.getElementById('t_regex').value.trim() || regexFromPreset(preset);
  }
  if(f.type==='checkbox' || f.type==='radio'){
    if(!validateUniqueOptions('o_list')) return; // جلوگیری از ذخیره مقادیر تکراری
    f.orientation = document.getElementById('o_orientation').value;
    const list = document.getElementById('o_list');
    f.options = Array.from(list.querySelectorAll('.option-row')).map(row=> ({
      value: row.querySelector('.opt-value').value.trim(),
      label: row.querySelector('.opt-label').value.trim(),
      desc:  row.querySelector('.opt-desc').value.trim()
    })).filter(o=>o.label);
  }
  if(f.type==='combo'){
    if(f.optionsSource==='manual'){
      if(!validateUniqueOptions('c_list')) return;
    }
    f.optionsSource = document.getElementById('c_source').value;
    f.codingKey = document.getElementById('c_coding').value;
    if(f.optionsSource==='manual'){
      const list = document.getElementById('c_list');
      f.options = Array.from(list.querySelectorAll('.option-row')).map(row=> ({
        value: row.querySelector('.opt-value').value.trim(),
        label: row.querySelector('.opt-label').value.trim(),
        desc:  row.querySelector('.opt-desc').value.trim()
      })).filter(o=>o.label);
    }else{
      f.options = []; // در زمان اجرا از DB
    }
  }

  saveToStorage(); renderAll(); closeModal();
}

function regexFromPreset(p){
  switch(p){
    case 'email': return '^[\\w.-]+@[\\w.-]+\\.[A-Za-z]{2,}$';
    case 'mobile': return '^09\\d{9}$';
    case 'nationalId': return '^\\d{10}$';
    case 'postalCode': return '^\\d{10}$';
    default: return '';
  }
}

/* ---------- Export/Import/Data ---------- */
function exportJSON(){ document.getElementById('jsonSchema').value = JSON.stringify({fields}, null, 2); }
function importJSON(){
  try{
    const txt = document.getElementById('jsonImport').value.trim();
    if(!txt) return alert('متن JSON خالی است');
    const obj = JSON.parse(txt);
    if(!obj.fields || !Array.isArray(obj.fields)) throw new Error('ساختار fields یافت نشد');
    fields = obj.fields;
    saveToStorage(); renderAll(); alert('✅ وارد شد');
  }catch(e){ alert('❌ JSON نامعتبر: ' + e.message); }
}
function collectData(){
  const form = document.getElementById('formPreview');
  const data = {};
  new FormData(form).forEach((v,k)=>{
    if(data[k]){
      if(!Array.isArray(data[k])) data[k]=[data[k]];
      data[k].push(v);
    } else data[k]=v;
  });
  document.getElementById('dataOutput').value = JSON.stringify(data, null, 2);
  exportJSON();
  return data;
}

/* ---------- Helpers ---------- */
function escapeHtml(s){ return (s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }

function renderAll(){ renderBuilder(); renderPreview(); exportJSON(); }

loadFromStorage();
</script>

<script>
function validateUniqueOptions(containerId) {
  const rows = document.querySelectorAll('#' + containerId + ' .option-row');
  const values = new Set();
  const labels = new Set();
  for (let row of rows) {
    const v = row.querySelector('.opt-value').value.trim();
    const l = row.querySelector('.opt-label').value.trim();
    if (values.has(v) || labels.has(l)) {
      alert('برچسب یا مقدار تکراری است: ' + (l || v));
      return false;
    }
    if (v) values.add(v);
    if (l) labels.add(l);
  }
  return true;
}
</script>


<script>
// Tooltip for desktop hover and mobile click
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.tooltip-icon').forEach(icon => {
    const text = icon.getAttribute('data-tooltip') || '';
    if (!text) return;
    // Hover (desktop)
    icon.addEventListener('mouseenter', () => {
      let tip = document.createElement('div');
      tip.className = 'custom-tooltip';
      tip.innerText = text;
      document.body.appendChild(tip);
      const rect = icon.getBoundingClientRect();
      tip.style.position = 'absolute';
      tip.style.left = rect.left + window.scrollX + 'px';
      tip.style.top = rect.bottom + window.scrollY + 'px';
      tip.style.background = '#333';
      tip.style.color = '#fff';
      tip.style.padding = '4px 8px';
      tip.style.borderRadius = '4px';
      tip.style.fontSize = '12px';
      tip.style.zIndex = '1000';
      icon._tooltipEl = tip;
    });
    icon.addEventListener('mouseleave', () => {
      if (icon._tooltipEl) {
        icon._tooltipEl.remove();
        icon._tooltipEl = null;
      }
    });
    // Click (mobile)
    icon.addEventListener('click', () => {
      alert(text);
    });
  });
});
</script>


<script>
document.addEventListener('click', function(e){
  if(e.target.type === 'radio'){
    if(e.target.wasChecked){
      e.target.checked = false;
    }
    document.querySelectorAll(`input[name="${e.target.name}"]`).forEach(r=> r.wasChecked=false);
    if(e.target.checked) e.target.wasChecked = true;
  }
});
</script>

</body>
</html>
